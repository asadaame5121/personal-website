name: Webmentioné€ä¿¡è‡ªå‹•åŒ–

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ'
        required: false
        default: false
        type: boolean

jobs:
  send-webmentions:
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Deno ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: denoland/setup-deno@v2
      with:
        deno-version: v2.x
        
    - name: ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      uses: actions/cache@v3
      with:
        path: ~/.cache/deno
        key: ${{ runner.os }}-deno-${{ hashFiles('**/deno.lock') }}
        restore-keys: |
          ${{ runner.os }}-deno-
          
    - name: Webmentioné€ä¿¡å®Ÿè¡Œ
      run: |
        if [ "${{ github.event.inputs.dry_run }}" = true ]; then
          echo "ğŸ” ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
          deno run --allow-net --allow-read --allow-write scripts/send-webmentions.ts --dry-run
        else
          echo "ğŸš€ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
          deno run --allow-net --allow-read --allow-write scripts/send-webmentions.ts
        fi
      working-directory: .
      
    - name: å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒŸãƒƒãƒˆ
      if: github.event.inputs.dry_run != 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/webmention-history.json
        if git diff --staged --quiet; then
          echo "å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
        else
          git commit -m "ğŸ¤– Webmentioné€ä¿¡å±¥æ­´ã‚’æ›´æ–° $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi
        
    - name: å®Ÿè¡Œçµæœé€šçŸ¥
      if: failure()
      run: |
        echo "âŒ Webmentioné€ä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        echo "è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
